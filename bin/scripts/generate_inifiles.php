<?php
Xorc::dbconnect($opts["db"], "_db");

$path=$opts['t'];

$tab=$_db->MetaTables('TABLES');

$naming=new Naming;

if(!is_dir("$path/schema")){
	print("creating schemadir $path/schema ..");
	if(mkdir("$path/schema")){
		print " .. OK\n";
	}else{
		print " .. FAILED\n";
	}
}

foreach($tab as $t){
	
	$tname=strtolower($t);
	
	
	if($opts['prefix']){
		if(preg_match("/^{$opts['prefix']}_(.*)$/", $tname, $mat)){
			$fname=$mat[1];
			$fname=$naming->singular($fname);
			$tname=$mat[1];
		}else{
			continue;
		}
	}else{
		$fname=$naming->singular($tname);
	}
	
	print("[$tname]\n");
	
	$def="; autogenerated file - generator: generator.php\n[table]\nname=$tname\n\n[keys]\n";
	$keys=$_db->MetaPrimaryKeys($t);
	if($keys) foreach($keys as $k){
		$def.=strtolower($k)."=1\n";
	}
	
	$def.="\n[fields]\n; 1-number, 2-string, 3-date, 4-datetime, 5-blob\n";
	$autod=""; $autoi="";
	
	$cols=$_db->MetaColumns($t);	
	foreach($cols as $c){
		$colname=strtolower($c->name);
		if(preg_match("/int|number/i", $c->type)){
			$type=1;
			if($colname=='version') $autoi.="version=1\n";
		}elseif(preg_match("/char|text/i", $c->type)){
			$type=2;
		}elseif(preg_match("/time/i", $c->type)){
			$type=4;
			if($colname=='created') $autod.="created=created\n";
			if($colname=='modified') $autod.="modified=modified\n";
		}elseif(preg_match("/date/i", $c->type)){
			$type=4;	//oracledate == datetime
		}elseif(preg_match("/lob/i", $c->type)){
			$type=5;
		}else{
			$type="???unknown type???";
			print "\n*** WARNING: unknown type {$c->type} in table $t, column {$colname} ***\n".
					"*** please refine the inifile by yourself ***\n\n";
		}
		$def.="$colname=$type\n";
	}

	if($autod) $def.="\n[autodate]\n".$autod;
	if($autoi) $def.="\n[autoinc]\n".$autoi;
		
	$inifile="$path/schema/{$fname}.ini";
	$clasfile="$path/{$fname}.class";
	
	file_write_dialog($inifile, "inifile", $def);
	if(!$opt['noclasses']){
		$classname=ucfirst($fname);
    $classdef="<"."?php\nclass $classname extends XorcStore{\n}\n?".">";
		file_write_dialog($clasfile, "classfile", $classdef);
	}
}

$appfile=$opts['app']?$opts['app']:basename($path);
$appfile="$path/{$appfile}.ini";
$cont=str_replace("%connect-string%", $opts['db'], join("", file("$mypath/templates/app.ini")));
$cont=str_replace("%table-prefix%", $opts['prefix'], $cont);
file_write_dialog($appfile, "app.ini", $cont);
	
$appfile=$opts['app']?$opts['app']:basename($path);
$appname=ucfirst($appfile);
$appfile="$path/{$appfile}.class";
$cont=str_replace("%app-name%", $appname, join("", file("$mypath/templates/app.class")));
file_write_dialog($appfile, "app.class", $cont);
	

?>
